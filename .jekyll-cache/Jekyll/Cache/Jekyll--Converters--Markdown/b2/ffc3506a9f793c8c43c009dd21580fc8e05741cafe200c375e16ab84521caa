I"îx<p>Facebook åœ¨æœ€è¿‘æ­£å¼æå‡ºäº† GraphQL çš„è¦æ ¼èˆ‡ç›¸å°æ‡‰çš„å¯¦ä½œã€‚GraphQL çš„å‡ºç¾ä¸»è¦æ˜¯æƒ³é™ä½ RESTful API åœ¨å–å¾—è¤‡é›œè³‡æ–™æ™‚ query çš„æ¬¡æ•¸ä¸¦åŒæ™‚ä¿æœ‰ RESTful é‚£æ¨£ç°¡å–®èˆ‡å¾Œç«¯æºé€šçš„æ–¹å¼ã€‚èˆ‰ä¸€å€‹åœ¨ <a href="https://blog.risingstack.com/graphql-overview-getting-started-with-graphql-and-nodejs/">RisingStack æ–‡ç« </a> ä¸­æåˆ°çš„ä¸€å€‹ä¾‹å­: ç•¶é–‹ç™¼è€…éœ€è¦å–å¾—ä½¿ç”¨è€…èˆ‡ä½¿ç”¨è€…çš„æœ‹å‹å€‘çš„è³‡è¨Šæ™‚ï¼Œå‚³çµ±çš„ RESTful æœƒç”¨ä»¥ä¸‹æ–¹å¼å–å¾—è³‡æ–™:</p>

<p><code class="language-plaintext highlighter-rouge">GET /users/1 and GET /users/1/friends  </code></p>

<p>æˆ–</p>

<p><code class="language-plaintext highlighter-rouge">GET /users/1?include=friends.name</code></p>

<p>æ›æˆä½¿ç”¨ GraphQL æ™‚ï¼Œå–å¾—åŒæ¨£è³‡æ–™çš„æ–¹æ³•å¦‚ä¸‹:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="nx">user</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">name</span>
        <span class="nx">age</span>
        <span class="nx">friends</span> <span class="p">{</span>
            <span class="nx">name</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å°é–‹ç™¼è€…è€Œè¨€ï¼ŒgraphQL çš„æ–¹æ³•æ›´ç‚ºç›´è§€ä¹Ÿæ›´å…·æœ‰å½ˆæ€§ã€‚é€™ä¹Ÿæ˜¯æœ¬ç¯‡ä¸»è¦æ¢è¨çš„ä¸»é¡Œ: å¦‚ä½•å¯¦ä½œ GraphQL APIã€‚
æœ¬ç¯‡ç¯„ä¾‹çš„åŸå§‹ç¢¼: <a href="https://github.com/Rhadow/graphQL-relay-example">graphQL-relay-example</a>ã€‚</p>

<h2 id="server">Server</h2>

<p>é€™æ¬¡è¦å¯¦ä½œçš„ GraphQL API æ˜¯ä»¥ express æ¡†æ¶å»ºç«‹çš„ Node ä¼ºæœå™¨ã€‚Database æ˜¯ä½¿ç”¨ MongoDB æ­é… <a href="http://mongoosejs.com/">Mongoose</a>ï¼Œè€Œ GraphQL éƒ¨åˆ†å‰‡æ˜¯ä½¿ç”¨ Facebook æä¾›çš„ <a href="https://github.com/graphql/graphql-js">graphql-js</a>ã€‚</p>

<p>è€å¯¦èªªï¼ŒGraphQL çš„ server éƒ¨åˆ†å…¶å¯¦éå¸¸ç°¡å–®ï¼Œç›´æ¥ä¾†çœ‹çœ‹ç¨‹å¼ç¢¼:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// server.js</span>

<span class="c1">// Express</span>
<span class="k">import</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">bodyParser</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">body-parser</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Mongoose</span>
<span class="k">import</span> <span class="nx">mongoose</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">mongoose</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// GraphQL</span>
<span class="k">import</span> <span class="nx">schema</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../schema/schema.js</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">graphql</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">graphql</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">DB_PATH</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">mongodb://localhost:27017/test</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// Connet to DB</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">DB_PATH</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">text</span><span class="p">({</span>
	<span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/graphql</span><span class="dl">'</span>
<span class="p">}));</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/graphql</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="nx">graphql</span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">});</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">address</span><span class="p">().</span><span class="nx">address</span><span class="p">;</span>
	<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">address</span><span class="p">().</span><span class="nx">port</span><span class="p">;</span>
	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Graphql is listening at https://</span><span class="p">${</span><span class="nx">host</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">});</span>

</code></pre></div></div>

<p>æ˜¯ä¸æ˜¯éå¸¸çš„ç›´æ¥ï¼Œèˆ‡å¹³å¸¸ä¸åŒçš„åœ°æ–¹åœ¨æ–¼ graphql èˆ‡ schemaã€‚graphql åªæ˜¯æŠŠ request çš„å…§å®¹èˆ‡ schema åšæ¯”å°ä¸¦å°‡çµæœé€å›ï¼Œè€Œ schema å‘¢ï¼Œå‰‡æ˜¯é€™æ¬¡ graphql çš„é‡é»ã€‚</p>

<h2 id="schema">Schema</h2>

<p>æˆ‘å€‘å…ˆå¾<a href="https://medium.com/@clayallsopp/your-first-graphql-server-3c766ab4f0a2">é€™ç¯‡æ–‡ç« </a>ä¸­å€Ÿä¸€å€‹ç°¡å–®çš„ä¾‹å­ä¾†çœ‹å¦‚ä½•å»ºç«‹ schema:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// schema.js</span>

<span class="k">import</span> <span class="p">{</span>
    <span class="nx">GraphQLObjectType</span><span class="p">,</span>
    <span class="nx">GraphQLSchema</span><span class="p">,</span>
    <span class="nx">GraphQLInt</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">graphql/lib/type</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">schema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GraphQLSchema</span><span class="p">({</span>
    <span class="na">query</span><span class="p">:</span> <span class="k">new</span> <span class="nx">GraphQLObjectType</span><span class="p">({</span>
        <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">RootQueryType</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">fields</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">count</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">type</span><span class="p">:</span> <span class="nx">GraphQLInt</span><span class="p">,</span>
                <span class="na">resolve</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">count</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">});</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">schema</span><span class="p">;</span>
</code></pre></div></div>

<p>æˆ‘å€‘ç”¨äº†ä¸€å€‹è »è¤‡é›œçš„é…ç½®å»ºç«‹äº†ä¸€å€‹ schema çš„å¯¦é«”ï¼Œè®“æˆ‘å€‘ä¾†ä»”ç´°çœ‹çœ‹é€™è¤‡é›œçš„é…ç½®æ˜¯æ€éº¼å›äº‹ã€‚</p>

<p>é¦–å…ˆæ˜¯ <code class="language-plaintext highlighter-rouge">query</code>: åœ¨æˆ‘å€‘èˆ‡ GraphQL æºé€šæ™‚ï¼Œéƒ½éœ€è¦è·Ÿ graphQL èªªæˆ‘å€‘è¦åšä»€éº¼äº‹(ä¾‹å¦‚: å–è³‡æ–™ï¼Œä¿®æ”¹è³‡æ–™ç­‰)ã€‚è€Œ <code class="language-plaintext highlighter-rouge">query</code> åº•ä¸‹çš„å…§å®¹å°±æ˜¯è®“æˆ‘å€‘è¨­å®šç•¶å–è³‡æ–™çš„å‹•ä½œç™¼ç”Ÿæ™‚ï¼ŒGraphQL å¯ä»¥æä¾›é‚£äº› APIã€‚ä»¥ä¸Šä¾‹ä¾†èªªï¼Œå¦‚æœå®ƒè®Šæˆ RESTful çš„è©±ï¼Œæœƒæ˜¯ <code class="language-plaintext highlighter-rouge">GET /count</code>ã€‚</p>

<p>æˆ‘å€‘å¯ä»¥é€éåœ¨ <code class="language-plaintext highlighter-rouge">fields</code> ä¸­å¢åŠ å…¶ä»–å±¬æ€§ä¾†æä¾›æ›´å¤šçš„ API å‡ºå»ã€‚æ¯å€‹ <code class="language-plaintext highlighter-rouge">fields</code> çš„å±¬æ€§éƒ½è‡³å°‘è¦æä¾›å®ƒæœƒå›å‚³çš„å‹åˆ¥ (<code class="language-plaintext highlighter-rouge">type</code>) èˆ‡å¦‚ä½•å›å‚³å¯¦éš›éœ€è¦çš„å€¼çš„å‡½å¼ (<code class="language-plaintext highlighter-rouge">resolve</code>)ã€‚</p>

<p>åœ¨ GraphQL çš„ä¸–ç•Œè£¡ï¼Œå‹åˆ¥å¾ˆé‡è¦ã€‚å› æ­¤ graphql-js æä¾›äº†å„å¼å„æ¨£çš„å‹åˆ¥ä¾›æˆ‘å€‘ä½¿ç”¨ã€‚æˆ‘å€‘é€é <code class="language-plaintext highlighter-rouge">GraphQLObjectType</code> å®šç¾©äº† <code class="language-plaintext highlighter-rouge">query</code> ä¹Ÿä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">GraphQLInt</code> ä¾†å‘ŠçŸ¥ count å›å‚³çš„å€¼å°‡æœƒæ˜¯å€‹ <code class="language-plaintext highlighter-rouge">Int</code>ã€‚</p>

<p>æ¥è‘—è®“æˆ‘å€‘ä¾†è©¦è‘—ä½¿ç”¨é€™å€‹ API:</p>

<p>å¦‚æœæ˜¯ç”¨ Postman çš„è©±ï¼Œéœ€è¦ POST ä»¥ä¸‹å…§å®¹åˆ° <code class="language-plaintext highlighter-rouge">/graphql</code> ä¸¦å°‡ Content-Type è¨­ç‚º <code class="language-plaintext highlighter-rouge">application/graphql</code> å³å¯:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>query RootQueryType {
	count
}

</code></pre></div></div>

<p>ç”¨æŒ‡ä»¤çš„è©±:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -XPOST -H "Content-Type:application/graphql"  -d 'query RootQueryType { count }' http://localhost:3000/graphql
</code></pre></div></div>

<p>ä»”ç´°åˆ†æå…§å®¹å…¶å¯¦ä¸é›£ç™¼ç¾èˆ‡ GraphQL çš„æºé€šæ¨¡å¼ï¼Œå…ˆèªªæ˜è¦åšä»€éº¼å‹•ä½œå†æä¾›éœ€è¦çš„è³‡æ–™æ ¼å¼å°±å¤§åŠŸå‘Šæˆå›‰ã€‚åå­—éƒ¨åˆ†(<code class="language-plaintext highlighter-rouge">RootQueryType</code>)ç›®å‰æ˜¯æœ‰é»å•é¡Œï¼Œç¶“éå¯¦é©—å°±ç®—éš¨ä¾¿äº‚æ‰“ä¹Ÿèƒ½æ­£å¸¸å–å¾—è³‡æ–™ï¼Œä½†ä¸çµ¦çš„è©±æœƒè·‘å‡ºèªæ³•éŒ¯èª¤ã€‚é€™éƒ¨åˆ†å¯èƒ½è¦çœ‹æœªä¾†å®˜æ–¹æœƒå¦‚ä½•æ”¹å–„ã€‚</p>

<p>GraphQL é‚„æœ‰æä¾›ä¸€å€‹ç‰¹åˆ¥çš„è¨­è¨ˆï¼Œå°±æ˜¯ç•¶ä½ ä¸æŒ‡å®šæ–¹æ³•æ™‚ï¼Œå®ƒæœƒè‡ªå‹•ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">query</code> æ¨¡å¼ã€‚å› æ­¤ï¼Œç”¨ä»¥ä¸‹æ–¹å¼ä¹Ÿèƒ½å–å¾— <code class="language-plaintext highlighter-rouge">count</code> çš„å€¼!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    count
}
</code></pre></div></div>

<h2 id="è‡ªè¨‚å‹åˆ¥">è‡ªè¨‚å‹åˆ¥</h2>

<p>å‰›æœ‰æåˆ° GraphQL çš„å‹åˆ¥å¾ˆé‡è¦ï¼Œé™¤äº†å®˜æ–¹æä¾›çš„å›ºå®šå‹åˆ¥å¤–ï¼Œæˆ‘å€‘ä¹Ÿèƒ½å¤ è‡ªè¨‚å‹åˆ¥ã€‚ä¸‹é¢å°‡ç¤ºç¯„è¦å¦‚ä½•è‡ªè¨‚:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// UserType.js</span>

<span class="k">import</span> <span class="p">{</span>
	<span class="nx">GraphQLObjectType</span><span class="p">,</span>
	<span class="nx">GraphQLList</span><span class="p">,</span>
	<span class="nx">GraphQLString</span><span class="p">,</span>
	<span class="nx">GraphQLInt</span><span class="p">,</span>
	<span class="nx">GraphQLID</span>
<span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">graphql</span><span class="dl">'</span><span class="p">;</span>

<span class="k">import</span> <span class="nx">ProductType</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../Product/ProductType.js</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">UserType</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GraphQLObjectType</span><span class="p">({</span>
	<span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">User</span><span class="dl">'</span><span class="p">,</span>
	<span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">A user</span><span class="dl">'</span><span class="p">,</span>
	<span class="na">fields</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span>
		<span class="na">_id</span><span class="p">:</span> <span class="p">{</span>
			<span class="na">type</span><span class="p">:</span> <span class="nx">GraphQLID</span><span class="p">,</span>
			<span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user id</span><span class="dl">'</span>
		<span class="p">},</span>
		<span class="na">name</span><span class="p">:</span> <span class="p">{</span>
			<span class="na">type</span><span class="p">:</span> <span class="nx">GraphQLString</span><span class="p">,</span>
			<span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user name</span><span class="dl">'</span>
		<span class="p">},</span>
		<span class="na">age</span><span class="p">:</span> <span class="p">{</span>
			<span class="na">type</span><span class="p">:</span> <span class="nx">GraphQLInt</span><span class="p">,</span>
			<span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user age</span><span class="dl">'</span>
		<span class="p">},</span>
		<span class="na">shoppingList</span><span class="p">:</span> <span class="p">{</span>
			<span class="na">type</span><span class="p">:</span> <span class="k">new</span> <span class="nx">GraphQLList</span><span class="p">(</span><span class="nx">ProductType</span><span class="p">),</span>
			<span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">List of products that user bought</span><span class="dl">'</span>
		<span class="p">}</span>
	<span class="p">})</span>
<span class="p">});</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">UserType</span><span class="p">;</span>
</code></pre></div></div>

<p>åœ¨çœ‹å®Œäº†å‰›å‰›è¤‡é›œçš„ schema å¾Œï¼Œé€™å€‹å°±ç›¸å°ç°¡å–®äº†å§ã€‚ä¸Šé¢çš„ç¨‹å¼ç¢¼å®šç¾©äº†ä¸€å€‹ <code class="language-plaintext highlighter-rouge">UserType</code> å‹åˆ¥ã€‚
é€™é‚Šæœ‰ç”¨åˆ°ä¸€äº›å‰›æ²’æåˆ°çš„æ–°å‹åˆ¥ï¼Œå¾ˆç›´è§€çš„ä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">GraphQLString</code> å°±å…ˆçœç•¥ä¸èªªæ˜äº†ã€‚</p>

<ul>
  <li>GraphQLID: å°ˆé–€çµ¦ ID ç”¨çš„å‹åˆ¥ï¼Œå¯ä»¥æ˜¯ <code class="language-plaintext highlighter-rouge">Int</code> æˆ–æ˜¯ <code class="language-plaintext highlighter-rouge">String</code></li>
  <li>GraphQLList: å…¶å¯¦å°±æ˜¯ <code class="language-plaintext highlighter-rouge">Array</code>ï¼Œåƒæ•¸å‰‡æ˜¯ array è£¡å€¼çš„å‹åˆ¥ã€‚åœ¨ä¸Šä¾‹ä¸­ç”¨äº†å¦ä¸€å€‹è‡ªè¨‚å‹åˆ¥ ProductTypeã€‚</li>
</ul>

<p>è‡ªè¨‚å‹åˆ¥ä½¿é–‹ç™¼è€…ä¸å†å—é™æ–¼åŸºæœ¬å‹åˆ¥ä¸¦èƒ½æä¾›å›å‚³æ›´è¤‡é›œçš„è³‡æ–™çµæ§‹ APIã€‚</p>

<h2 id="ä¿®æ”¹è³‡æ–™">ä¿®æ”¹è³‡æ–™</h2>

<p>èªªäº†é€™éº¼å¤šå–å€¼ï¼Œé‚£ä¿®æ”¹å‘¢? é¦–å…ˆæˆ‘å€‘å¿…é ˆå…ˆå›å»çœ‹çœ‹ Schemaã€‚åˆ¥å¿˜äº†æ‰€æœ‰çš„å‹•ä½œéƒ½æ˜¯å¾å®ƒé–‹å§‹çš„ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// schema.js</span>

<span class="kd">const</span> <span class="nx">schema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GraphQLSchema</span><span class="p">({</span>
	<span class="na">query</span><span class="p">:</span> <span class="k">new</span> <span class="nx">GraphQLObjectType</span><span class="p">({</span>
		<span class="p">...</span><span class="nx">çœç•¥</span>
	<span class="p">}),</span>
	<span class="na">mutation</span><span class="p">:</span> <span class="k">new</span> <span class="nx">GraphQLObjectType</span><span class="p">({</span>
		<span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">RootMutationType</span><span class="dl">'</span><span class="p">,</span>
		<span class="na">fields</span><span class="p">:</span> <span class="p">{</span>
			<span class="na">addUser</span><span class="p">:</span> <span class="p">{</span>
				<span class="na">type</span><span class="p">:</span> <span class="nx">UserType</span><span class="p">,</span>
				<span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Add a new user to list</span><span class="dl">'</span><span class="p">,</span>
				<span class="na">args</span><span class="p">:</span> <span class="p">{</span>
					<span class="na">name</span><span class="p">:</span> <span class="p">{</span>
						<span class="na">type</span><span class="p">:</span> <span class="k">new</span> <span class="nx">GraphQLNonNull</span><span class="p">(</span><span class="nx">GraphQLString</span><span class="p">),</span>
						<span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New user</span><span class="se">\'</span><span class="s1">s name</span><span class="dl">'</span>
					<span class="p">},</span>
					<span class="na">age</span><span class="p">:</span> <span class="p">{</span>
						<span class="na">type</span><span class="p">:</span> <span class="k">new</span> <span class="nx">GraphQLNonNull</span><span class="p">(</span><span class="nx">GraphQLInt</span><span class="p">),</span>
						<span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New user</span><span class="se">\</span><span class="s1">s age</span><span class="dl">'</span>
					<span class="p">},</span>
					<span class="na">shoppingList</span><span class="p">:</span> <span class="p">{</span>
						<span class="na">type</span><span class="p">:</span> <span class="k">new</span> <span class="nx">GraphQLNonNull</span><span class="p">(</span><span class="k">new</span> <span class="nx">GraphQLList</span><span class="p">(</span><span class="nx">GraphQLID</span><span class="p">)),</span>
						<span class="na">description</span><span class="p">:</span> <span class="dl">'</span><span class="s1">New user</span><span class="se">\</span><span class="s1">s shopping list</span><span class="dl">'</span>
					<span class="p">}</span>
				<span class="p">},</span>
				<span class="na">resolve</span><span class="p">:</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="p">{</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">age</span><span class="p">,</span> <span class="nx">shoppingList</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
					<span class="kd">let</span> <span class="nx">newUser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
					<span class="nx">newUser</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
					<span class="nx">newUser</span><span class="p">.</span><span class="nx">age</span> <span class="o">=</span> <span class="nx">age</span><span class="p">;</span>
					<span class="nx">newUser</span><span class="p">.</span><span class="nx">shoppingList</span> <span class="o">=</span> <span class="nx">shoppingList</span><span class="p">;</span>
					<span class="k">return</span> <span class="nx">newUser</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
				<span class="p">}</span>
			<span class="p">},</span>
		<span class="p">}</span>
	<span class="p">})</span>
<span class="p">});</span>
</code></pre></div></div>

<p>å“‡ï¼Œæ€éº¼åˆé€™éº¼å¤šè¡Œã€‚åˆ¥ç·Šå¼µï¼Œä»”ç´°ç ”ç©¶çš„è©±æœƒç™¼ç¾å…¶å¯¦èˆ‡ <code class="language-plaintext highlighter-rouge">query</code> å¤§åŒå°ç•°ã€‚ä¸ä¸€æ¨£çš„åœ°æ–¹åœ¨æ–¼æˆ‘å€‘æ–°å¢äº†ä¸€å€‹ <code class="language-plaintext highlighter-rouge">mutation</code> å±¬æ€§ï¼Œä»»ä½•é—œæ–¼ä¿®æ”¹è³‡æ–™çš„ API éƒ½è«‹æ”¾åœ¨ <code class="language-plaintext highlighter-rouge">mutation</code> åº•ä¸‹ã€‚å…¶å¯¦ä½ å¦‚æœå¤©ç”Ÿåéª¨è¦æ”¾åœ¨ <code class="language-plaintext highlighter-rouge">query</code> ä¸‹é¢ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œä½†ä½•å¿…é€™æ¨£æè‡ªå·±å‘¢?</p>

<p>åœ¨é€™è£¡æˆ‘å€‘å®šç¾©äº†ä¸€å€‹ <code class="language-plaintext highlighter-rouge">addUser</code> API ç”¨ä¾†æ–°å¢ç”¨æˆ¶ã€‚æ¥è‘—æˆ‘å€‘å¿«é€Ÿéä¸€ä¸‹è£¡é¢çš„å±¬æ€§:</p>

<ul>
  <li>type: èˆ‡ <code class="language-plaintext highlighter-rouge">query</code> ä»‹ç´¹æ™‚ç›¸åŒï¼Œä¸è§£é‡‹</li>
  <li>description: é—œæ–¼é€™å€‹ API çš„æè¿°ï¼Œåœ¨åš <a href="https://github.com/facebook/graphql/blob/master/spec/Section%204%20--%20Introspection.md">Introspection</a> æ™‚æœƒæœ‰å¹«åŠ©ï¼Œå¯æœ‰å¯ç„¡çš„å±¬æ€§ï¼Œä½†ç‚ºæ±‚å®Œæ•´æ€§å»ºè­°åŠ ä¸Šã€‚</li>
  <li>args: æä¾›çµ¦é€™å€‹ API çš„åƒæ•¸ï¼Œæ¯å€‹åƒæ•¸éƒ½éœ€è¦æŒ‡å®šå‹åˆ¥ã€‚ä¸Šä¾‹ä¸­ä½¿ç”¨åˆ°çš„ <code class="language-plaintext highlighter-rouge">GraphQLNonNull</code> æœƒå°‡åƒæ•¸è¨­ç‚ºç„¡æ³•ç‚º <code class="language-plaintext highlighter-rouge">null</code> çš„åƒæ•¸ï¼Œæ›å¥è©±èªªå°±æ˜¯å¿…å¡«ã€‚<code class="language-plaintext highlighter-rouge">args</code> ä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨ <code class="language-plaintext highlighter-rouge">query</code> çš„ API ä¸­ã€‚</li>
  <li>resolve: åŠŸèƒ½èˆ‡åœ¨ <code class="language-plaintext highlighter-rouge">query</code> æ®µè½æ™‚æåˆ°çš„ç›¸åŒã€‚éœ€è¦è£œå……çš„æ˜¯ï¼Œå›å‚³çš„å€¼å¯ä»¥æ˜¯ä¸€å€‹ promiseã€‚</li>
</ul>

<p>æ¥è‘—ä¾†çœ‹çœ‹å¦‚ä½•ä½¿ç”¨é€™æ”¯æ–°çš„ API å§!</p>

<p>Postman:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">mutation</span> <span class="nx">RootMutationType</span> <span class="p">{</span>
    <span class="nx">addUser</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span><span class="dl">"</span><span class="s2">Tester</span><span class="dl">"</span><span class="p">,</span> <span class="nx">age</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span> <span class="nx">shoppingList</span><span class="p">:</span> <span class="p">[])</span> <span class="p">{</span>
        <span class="nx">name</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æŒ‡ä»¤:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">curl</span> <span class="o">-</span><span class="nx">XPOST</span> <span class="o">-</span><span class="nx">H</span> <span class="dl">'</span><span class="s1">Content-Type:application/graphql</span><span class="dl">'</span>  <span class="o">-</span><span class="nx">d</span> <span class="err">â€˜</span><span class="nx">mutation</span> <span class="nx">RootMutationType</span> <span class="p">{</span> <span class="nx">addUser</span><span class="p">(</span><span class="nx">name</span><span class="p">:</span><span class="dl">"</span><span class="s2">Tester</span><span class="dl">"</span><span class="p">,</span> <span class="nx">age</span><span class="p">:</span> <span class="mi">999</span><span class="p">,</span> <span class="nx">shoppingList</span><span class="p">:</span> <span class="p">[])</span> <span class="p">{</span> <span class="nx">name</span> <span class="p">}</span> <span class="p">}</span><span class="dl">'</span><span class="s1"> http://localhost:3000/graphql
</span></code></pre></div></div>

<p>ä½¿ç”¨æ–¹æ³•ä¸Šèˆ‡ <code class="language-plaintext highlighter-rouge">query</code> ç›¸åŒï¼Œä¸éé€™æ¬¡å°±ç„¡æ³•çœç•¥æ–¹æ³•èˆ‡åå­—äº†ã€‚</p>

<h2 id="èˆ‡-database-é€£çµ">èˆ‡ Database é€£çµ</h2>

<p>å…¶å¯¦ GraphQL èˆ‡ Database çš„é€£çµä¸¦æ²’æœ‰å¤ªæ·±ï¼ŒGraphQL åªæœƒå°‡ <code class="language-plaintext highlighter-rouge">resolve</code> å…§ return çš„è³‡æ–™æ ¹æ“šé–‹ç™¼è€…è¦æ±‚çš„æ ¼å¼å›å‚³å›å»ï¼Œè‡³æ–¼è¦å¦‚ä½•ç”Ÿæˆé€™äº›è³‡æ–™ï¼Œå…¶å¯¦æ˜¯ç”± Database æˆ–æ˜¯å…¶ä»–çš„é‚è¼¯ä¾†è™•ç†ï¼Œèˆ‡ GraphQL æ²’æœ‰ä»€éº¼é—œä¿‚ã€‚</p>

<p>èˆ‰ä¾‹ä¾†èªªï¼Œä¸€å€‹ä½¿ç”¨è€…çš„è³¼ç‰©è»Šè£¡æœ‰å¤šå€‹å•†å“ï¼Œé–‹ç™¼è€…æƒ³è¦å–å¾—ä½¿ç”¨è€…çš„å§“åèˆ‡ä»–è³¼è²·å•†å“çš„åç¨±ã€‚</p>

<p>ä½¿ç”¨è€…ç¯„ä¾‹è³‡æ–™:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Example user</span>
<span class="p">{</span>
    <span class="nl">_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HOWARDS ID</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Howard</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">age</span><span class="p">:</span> <span class="mi">27</span><span class="p">,</span>
    <span class="nx">shoppingList</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">PRODUCT 1 ID</span><span class="dl">'</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å•†å“ç¯„ä¾‹è³‡æ–™:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Example product</span>
<span class="p">{</span>
    <span class="nl">_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">PRODUCT 1 ID</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">MacBook Pro</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">category</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">electronics</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">apple</span><span class="dl">'</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç•¶é–‹ç™¼è€…ç”¨ä¸‹åˆ— <code class="language-plaintext highlighter-rouge">query</code> å–å€¼æ™‚:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="nx">user</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">HOWARDS ID</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">name</span><span class="p">,</span>
        <span class="nx">shoppingList</span> <span class="p">{</span>
            <span class="nx">name</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>user API å…§çš„ <code class="language-plaintext highlighter-rouge">resolve</code> è¦å›å‚³çš„å€¼æœƒæ˜¯:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
	<span class="nl">_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HOWARDS ID</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Howard</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">age</span><span class="p">:</span> <span class="mi">27</span><span class="p">,</span>
    <span class="nx">shoppingList</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
		    <span class="na">_id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">PRODUCT 1 ID</span><span class="dl">'</span><span class="p">,</span>
		    <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">MacBook Pro</span><span class="dl">'</span><span class="p">,</span>
		    <span class="na">category</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">electronics</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">apple</span><span class="dl">'</span><span class="p">]</span>
		<span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å¤§å®¶å¯èƒ½æœƒèªç‚º GraphQL é€™éº¼æœ‰å½ˆæ€§ï¼Œå¾ DB å–è³‡æ–™å¾Œåˆè¦ä¾ç…§ query çš„æ ¼å¼è¼¸å‡ºä¸€å®šå¾ˆéº»ç…©ã€‚ä½†äº‹å¯¦ä¸Šæ˜¯ï¼Œæˆ‘å€‘åªè¦æŠŠå®Œæ•´çš„è³‡æ–™å¾ DB éƒ½å–å¥½æŠŠå®ƒå€‘çµ„èµ·ä¾†ï¼Œå†ç”± GraphQL ä¾ç…§ query çš„æ ¼å¼å›å‚³çµ¦ä½¿ç”¨è€…å°±å®Œæˆäº†ã€‚ä»¥ä¸Šä¾‹ä¾†èªªï¼Œé›–ç„¶ query å…§ä¸¦æ²’æœ‰è¦æ±‚è¦å›å‚³ä½¿ç”¨è€…çš„å¹´é½¡ä¹Ÿæ²’æœ‰è¦æ±‚è¦å›å‚³å•†å“çš„ç¨®é¡ï¼Œä½†æ˜¯è³‡æ–™é‚„æ˜¯å®Œæ•´çš„è¢«å–å›ä¾†ä»¥å°æ‡‰æœªä¾†çš„è®Šå‹•ã€‚</p>

<h2 id="ç¸½çµ">ç¸½çµ</h2>

<p>GraphQL å¸¶çµ¦äº†å‰ç«¯æ›´æœ‰å½ˆæ€§çš„ APIï¼Œä¹Ÿæä¾›é–‹ç™¼è€…å€‘é™¤äº† RESTful ä¹‹å¤–çš„å¦ä¸€ç¨®æ–¹å¼ä¾†èˆ‡å¾Œç«¯æºé€šã€‚å€‹äººèªç‚º GraphQL æŠŠä¸€éƒ¨åˆ†å‰ç«¯çš„å·¥ä½œé‡è½‰ç§»åˆ°å¾Œç«¯äº†ï¼Œå› æ­¤é©ç•¶çš„å»äº†è§£å¾Œç«¯æ¶æ§‹ä¸¦å­¸ç¿’æ‰èƒ½è®“è‡ªå·±èƒ½å¤ åœ¨ GraphQL èˆ‡ RESTful ä¸­ä½¿ç”¨æœ€é©åˆè§£æ±ºå•é¡Œçš„æ–¹æ³•ã€‚æƒ³è¦çœ‹è©³ç´°ç¨‹å¼ç¢¼å…§å®¹è«‹åˆ°: <a href="https://github.com/Rhadow/graphQL-relay-example">graphQL-relay-example</a> æŸ¥çœ‹ã€‚</p>
:ET