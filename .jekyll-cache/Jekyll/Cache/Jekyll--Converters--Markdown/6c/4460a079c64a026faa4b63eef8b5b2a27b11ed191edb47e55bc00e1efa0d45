I"€f<p>ç¹¼<a href="https://rhadow.github.io/2015/04/24/Jest-with-React/">ä¸Šä¸€ç¯‡</a>åˆ†äº«äº†å¦‚ä½•ä½¿ç”¨ <a href="https://facebook.github.io/jest/">Jest</a> å° React å…ƒä»¶åšå–®å…ƒæ¸¬è©¦ï¼Œæœ¬ç¯‡å°‡æŠŠç„¦é»å°ˆæ³¨åœ¨å¦‚ä½•å° <a href="https://facebook.github.io/flux/">Flux</a> åšå–®å…ƒæ¸¬è©¦ã€‚å°æ–¼æ¸¬è©¦ä¾†èªªï¼Œæˆ‘å€‘å¿…é ˆå°‡è¢«æ¸¬çš„æ¨¡çµ„ç¨ç«‹æ–¼å…¶ä»–æ¨¡çµ„ï¼Œå› æ­¤ï¼ŒJest çš„è‡ªå‹•æ¨¡æ“¬åŒ–å°‡æ¸¬è©¦æ•´å€‹ Flux è¨­è¨ˆæ¨¡å¼çš„æµç¨‹è®Šå¾—æ›´ç‚ºå®¹æ˜“ã€‚</p>

<h2 id="tldr">TL;DR</h2>

<p>å¦‚æœå°ä½ ä¾†èªªç¨‹å¼ç¢¼æ¯”æ–‡å­—æ›´å®¹æ˜“è®€çš„è©±ï¼Œæœ¬ç¯‡å…§æ‰€æœ‰çš„ç¨‹å¼ç¢¼éƒ½æ”¾åœ¨<a href="https://github.com/Rhadow/Flux-Reflux-Practice">é€™è£¡</a>ï¼Œè«‹ç›´æ¥åƒè€ƒã€‚</p>

<h2 id="flux-ç°¡ä»‹">Flux ç°¡ä»‹</h2>

<p>Flux ä¸»è¦æ˜¯ç”± Action, Dispatcher, Store èˆ‡ View æ‰€çµ„æˆã€‚ä½¿ç”¨è€…é€éèˆ‡ View çš„äº’å‹•ï¼Œç™¼é€ä¸åŒçš„ Actionï¼Œå†ç”± Dispatcher å°‡é€™äº› Action åˆ†é…çµ¦å„å€‹ Store ä¾†è®Šæ›´å…§éƒ¨è³‡æ–™ï¼Œç•¶ Store è³‡æ–™æ”¹è®Šå¾Œï¼Œå†å°‡ View æ›´æ–°åšä¸€æ¬¡å¾ªç’°ã€‚å¦‚ä¸‹åœ–æ‰€ç¤ºï¼š</p>

<p><img src="http://blog.krawaller.se/img/flux-diagram.png" alt="Image of Flux" /></p>

<p>ä»¥å–®å…ƒæ¸¬è©¦çš„è§’åº¦ä¾†çœ‹ï¼Œæˆ‘å€‘å·²ç¶“åœ¨<a href="https://rhadow.github.io/2015/04/24/Jest-with-React/">ä¸Šä¸€ç¯‡</a>è§£æ±ºäº†å° View (React å…ƒä»¶) èˆ‡ Action (æ˜¯å¦æ­£å¸¸ç™¼é€) çš„æ¸¬è©¦ï¼ŒDispatcher å‰‡æ˜¯ç”±å®˜æ–¹æä¾›ã€‚å› æ­¤ï¼Œæˆ‘å€‘çœŸæ­£éœ€è¦å¯«å–®å…ƒæ¸¬è©¦çš„éƒ¨åˆ†å…¶å¯¦åªæœ‰ Store è€Œå·²ã€‚</p>

<h2 id="æ¸¬è©¦-store">æ¸¬è©¦ Store</h2>

<p>é¦–å…ˆè®“æˆ‘å€‘å¤§è‡´çœ‹ä¸€ä¸‹å³å°‡è¢«æ¸¬è©¦çš„ Storeï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">appDispatcher</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../dispatcher/dispatcher.js</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">eventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">events</span><span class="dl">'</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">constants</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../constants/constants.js</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">underscore</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">_userList</span> <span class="o">=</span> <span class="p">[{</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Howard</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">age</span><span class="p">:</span> <span class="mi">27</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Shaun</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">age</span><span class="p">:</span> <span class="mi">22</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Amy</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">age</span><span class="p">:</span> <span class="mi">26</span>
<span class="p">}];</span>

<span class="kd">var</span> <span class="nx">appStore</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">eventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">getUserList</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_userList</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="na">addUser</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_userList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">deleteUser</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_userList</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">emitChange</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">addChangeListener</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">removeChangeListener</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">change</span><span class="dl">'</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>

<span class="nx">appDispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">actionType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">ADD_USER</span><span class="p">:</span>
            <span class="nx">appStore</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">DELETE_USER</span><span class="p">:</span>
            <span class="nx">appStore</span><span class="p">.</span><span class="nx">deleteUser</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">appStore</span><span class="p">.</span><span class="nx">emitChange</span><span class="p">();</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">appStore</span><span class="p">;</span>

</code></pre></div></div>

<p>é€™æ˜¯ä¸€å€‹ç°¡å–®çš„ Store æ­é…ã€åŠ å…¥æ–°ä½¿ç”¨è€…ã€èˆ‡ã€åˆªé™¤ä½¿ç”¨è€…ã€é€™å…©å€‹ Actionï¼ŒåŒæ™‚é è¨­æœ‰ä¸‰å€‹ä½¿ç”¨è€…å·²ç¶“å­˜åœ¨ã€‚</p>

<p>å¼•ç”¨æ–¼ Facebook å®˜æ–¹çš„èªªæ³•ï¼š</p>

<blockquote>
  <p>By design, stores canâ€™t be modified from the outside. They have no setters. The only way new data can enter a store
is through the callback it registers with the dispatcher.</p>
</blockquote>

<p>å¤§è‡´ä¸Šçš„ç¿»è­¯æ˜¯ï¼šStore çš„å…§éƒ¨è³‡æ–™ç„¡æ³•å¾å¤–éƒ¨ç›´æ¥ä¿®æ”¹ï¼Œå”¯ä¸€å°‡æ–°è³‡æ–™åŠ é€² Store çš„æ–¹æ³•å°±æ˜¯é€é dispatcher è¨»å†Šçš„å›å‘¼å‡½å¼è£¡é¢çš„å„å€‹ Action å°‡è³‡æ–™å¸¶å…¥ã€‚ä»¥æˆ‘å€‘çš„ä¾‹å­ä¾†èªªå°±æ˜¯ä»¥ä¸‹é€™éƒ¨åˆ†ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">appDispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">action</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">actionType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">ADD_USER</span><span class="p">:</span>
            <span class="nx">appStore</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">DELETE_USER</span><span class="p">:</span>
            <span class="nx">appStore</span><span class="p">.</span><span class="nx">deleteUser</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="nl">default</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">appStore</span><span class="p">.</span><span class="nx">emitChange</span><span class="p">();</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<p>ç”±æ–¼éœ€è¦æ¨¡æ“¬ä¸åŒçš„ Action ï¼Œæˆ‘å€‘å‹¢å¿…éœ€è¦åœ¨æ¸¬è©¦ä¸­å°‡å¾ä»¥ä¸Šå›å‘¼å‡½å¼å–å‡ºä¾†ï¼Œé€™æ¨£æ‰èƒ½ä¸Ÿé€²ä¸åŒçš„ <code class="language-plaintext highlighter-rouge">payload</code> ä¾†æ¨¡æ“¬ä¸åŒçš„ Actionã€‚å¹¸é‹çš„æ˜¯ï¼Œç¶“é Jest æ¨¡æ“¬åŒ– (mock) éå¾Œçš„ <code class="language-plaintext highlighter-rouge">register()</code> å‡½å¼æœƒæœ‰ä¸€å€‹å«åš <code class="language-plaintext highlighter-rouge">mock</code> çš„å±¬æ€§ã€‚å®ƒæœƒè¨˜éŒ„è‘—æ‰€æœ‰æœ‰é—œ <code class="language-plaintext highlighter-rouge">register()</code> è¢«å‘¼å«çš„ç´€éŒ„ï¼ŒåŒ…æ‹¬æ¬¡æ•¸ï¼Œåƒæ•¸ç­‰ç­‰ã€‚æ–¼æ˜¯ï¼Œæˆ‘å€‘å°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç¨‹å¼ç¢¼å°‡ä¸Šè¿°çš„å›å‘¼å‡½å¼å–å‡ºäº†ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mockRegister</span> <span class="o">=</span> <span class="nx">appDispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">;</span>
<span class="c1">//æ¨¡æ“¬åŒ–éå¾Œçš„ regeister()</span>

<span class="kd">var</span> <span class="nx">mockRegisterInfo</span> <span class="o">=</span> <span class="nx">mockRegister</span><span class="p">.</span><span class="nx">mock</span><span class="p">;</span>
<span class="c1">//æ‰¾å‡ºè¨˜éŒ„æ‰€æœ‰è³‡è¨Šçš„ mock å±¬æ€§</span>

<span class="kd">var</span> <span class="nx">callsToRegister</span> <span class="o">=</span> <span class="nx">mockRegisterInfo</span><span class="p">.</span><span class="nx">calls</span><span class="p">;</span>
<span class="c1">//æ‰¾å‡ºå‘¼å«ç´€éŒ„</span>

<span class="kd">var</span> <span class="nx">firstCall</span> <span class="o">=</span> <span class="nx">callsToRegister</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="c1">//å–å‡ºç¬¬ä¸€æ¬¡å‘¼å«çš„ç´€éŒ„</span>

<span class="kd">var</span> <span class="nx">firstArgument</span> <span class="o">=</span> <span class="nx">firstCall</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="c1">//å–å‡ºç¬¬ä¸€æ¬¡å‘¼å«çš„åƒæ•¸</span>

<span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">firstArgument</span><span class="p">;</span>
<span class="c1">//éœ€è¦çš„çµæœ</span>
</code></pre></div></div>

<p>å¦‚æœä¸Šé¢çš„ç¨‹å¼ç¢¼å°ä½ ä¾†èªªå¾ˆé™Œç”Ÿçš„è©±ï¼Œå»ºè­°å¯ä»¥é–±è®€ <a href="https://facebook.github.io/jest/docs/mock-functions.html#content">Jest å®˜æ–¹å° Mock Function çš„èªªæ˜</a>ã€‚åœ¨æˆ‘å€‘ç¹¼çºŒä¹‹å‰ï¼Œè®“æˆ‘å€‘å…ˆç°¡åŒ–ä¸€ä¸‹ç¨‹å¼ç¢¼ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">callback</span> <span class="o">=</span> <span class="nx">appDispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
</code></pre></div></div>

<p>æœ‰äº†é€™å€‹å›å‘¼å‡½å¼ä¹‹å¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥éš¨å¿ƒæ‰€æ¬²çš„æ¨¡æ“¬å„ç¨® Action ä¸Ÿå…¥ Store ä¾†åšæ¸¬è©¦äº†ï¼</p>

<h2 id="æ•´åˆ">æ•´åˆ</h2>

<p>æ¥ä¸‹ä¾†è®“æˆ‘å€‘ä¾†çœ‹çœ‹å®Œæ•´çš„æ¸¬è©¦ç¨‹å¼ç¢¼é•·å¾—å¦‚ä½•å§ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">jest</span><span class="p">.</span><span class="nx">dontMock</span><span class="p">(</span><span class="dl">'</span><span class="s1">../src/app/stores/appStore.js</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">jest</span><span class="p">.</span><span class="nx">dontMock</span><span class="p">(</span><span class="dl">'</span><span class="s1">underscore</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">appStore</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">appStore</span><span class="p">,</span>
        <span class="nx">appDispatcher</span><span class="p">,</span>
        <span class="nx">callback</span><span class="p">,</span>
        <span class="nx">constants</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../src/app/constants/constants.js</span><span class="dl">'</span><span class="p">),</span>
        <span class="nx">addUserAction</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">action</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">actionType</span><span class="p">:</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">ADD_USER</span><span class="p">,</span>
                <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Tester</span><span class="dl">'</span><span class="p">,</span>
                    <span class="na">age</span><span class="p">:</span> <span class="mi">27</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">deleteUserAction</span> <span class="o">=</span> <span class="p">{</span>
            <span class="na">action</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">actionType</span><span class="p">:</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">DELETE_USER</span><span class="p">,</span>
                <span class="na">data</span><span class="p">:</span> <span class="dl">'</span><span class="s1">replace me in test</span><span class="dl">'</span>
            <span class="p">}</span>
        <span class="p">};</span>

    <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">appStore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../src/app/stores/appStore.js</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">appDispatcher</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../src/app/dispatcher/dispatcher.js</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">callback</span> <span class="o">=</span> <span class="nx">appDispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should register a callback to store</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">appDispatcher</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">calls</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should initialize with a preset data</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">appStore</span><span class="p">.</span><span class="nx">getUserList</span><span class="p">()).</span><span class="nx">toEqual</span><span class="p">([{</span>
            <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Howard</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">age</span><span class="p">:</span> <span class="mi">27</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Shaun</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">age</span><span class="p">:</span> <span class="mi">22</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Amy</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">age</span><span class="p">:</span> <span class="mi">26</span>
        <span class="p">}]);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should add a new user after addUserAction is fired</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">addUserAction</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">allUsers</span> <span class="o">=</span> <span class="nx">appStore</span><span class="p">.</span><span class="nx">getUserList</span><span class="p">();</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">allUsers</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">allUsers</span><span class="p">[</span><span class="nx">allUsers</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]).</span><span class="nx">toEqual</span><span class="p">({</span>
            <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Tester</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">age</span><span class="p">:</span> <span class="mi">27</span>
        <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">should delete user according to index after deleteUserAction is fired</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">deleteUserAction</span><span class="p">.</span><span class="nx">action</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">deleteUserAction</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">allUsers</span> <span class="o">=</span> <span class="nx">appStore</span><span class="p">.</span><span class="nx">getUserList</span><span class="p">();</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">allUsers</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">allUsers</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">([{</span>
            <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Howard</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">age</span><span class="p">:</span> <span class="mi">27</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Amy</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">age</span><span class="p">:</span> <span class="mi">26</span>
        <span class="p">}]);</span>
    <span class="p">});</span>
<span class="p">});</span>

</code></pre></div></div>

<p>æ•´é«”çš„æ¸¬è©¦ç¨‹å¼ç¢¼çœ‹èµ·ä¾†å…¶å¯¦éå¸¸ç›´æ¥æ˜ç™½ï¼Œé€™ä¹Ÿæ˜¯å–®å…ƒæ¸¬è©¦çš„ä¸€å€‹è¦é»ï¼Œè®€èµ·ä¾†å¿…é ˆè¦åƒèªªæ˜æ–‡ä»¶ä¸€æ¨£ã€‚</p>

<p>é€™éƒ¨åˆ†æ¯”è¼ƒéœ€è¦æ³¨æ„çš„åœ°æ–¹æœ‰å…©é»ï¼š</p>

<p>ç¬¬ä¸€æ˜¯æˆ‘å€‘åœ¨æœ€é–‹å§‹ç‰¹åˆ¥å‘Šè¨´ Jest é™¤äº†ä¸è¦æ¨¡æ“¬ (<code class="language-plaintext highlighter-rouge">dontMock()</code>) é€™æ¬¡æ¸¬è©¦çš„ Store å¤–ï¼ŒåŒæ™‚ä¹Ÿä¸è¦æ¨¡æ“¬ underscoreã€‚
åŸå› æ˜¯æˆ‘å€‘çš„ Store æ˜¯ç”± <code class="language-plaintext highlighter-rouge">_.extend</code> æ–¹æ³•æ‰€çµ„æˆã€‚é€é Jest è‡ªå‹•æ¨¡æ“¬éå¾Œçš„æ¨¡çµ„æ˜¯ä¸å¸¶æœ‰ä»»ä½•é‚è¼¯çš„ï¼Œå› æ­¤ï¼Œå¦‚æœä½ æ˜¯ä½¿ç”¨åˆ¥çš„æ–¹æ³•çµ„ Store çš„è©±ï¼Œè«‹è¨˜å¾—è¦ç‰¹åˆ¥æé†’ Jestã€‚</p>

<p>ç¬¬äºŒå‰‡æ˜¯æˆ‘å€‘åœ¨æ¯æ¬¡çš„å°æ¸¬è©¦ä¹‹å‰ (<code class="language-plaintext highlighter-rouge">it()</code>) éƒ½æœƒé‡æ–°è¼‰å…¥ä¸€é Store ä»¥å…è¢«å‰ä¸€æ¬¡å°æ¸¬è©¦çš„çµæœå½±éŸ¿åˆ°ã€‚</p>

<h2 id="ç¸½çµ">ç¸½çµ</h2>

<p>å…¶å¯¦ä½¿ç”¨ Jest æ¸¬è©¦ Flux Store æœƒæ¯”æ¸¬è©¦ React å…ƒä»¶å–®ç´”è¨±å¤šï¼Œæˆ‘å€‘ä¸éœ€è¦ä½¿ç”¨åˆ° <a href="https://facebook.github.io/react/docs/test-utils.html">React Test Utilities</a>ï¼Œä¹Ÿä¸éœ€è¦ç‰¹åˆ¥ç‚º jsx å»ºç«‹ä¸€å€‹ <code class="language-plaintext highlighter-rouge">preprocessor.js</code>ã€‚ä½†æ˜¯ï¼Œç•¶æ‡‰ç”¨ç¨‹å¼çš„è¦æ¨¡è¶Šè®Šè¶Šå¤§ï¼ŒStore ä¹‹é–“äº’ç›¸æœ‰ä¾è³´æ€§æ™‚ï¼Œå¯èƒ½å°±æœƒéœ€è¦ä½¿ç”¨åˆ°ä¸€äº›é€²éšæŠ€å·§ï¼Œä¾‹å¦‚ï¼šæ‰‹å‹•å»ºç«‹æ¨¡æ“¬å‡½å¼ (Manual mocks)ã€‚é€™äº›éƒ½æœ‰åœ¨ Jest å®˜ç¶²ä¸Šåšä»‹ç´¹ã€‚æœªä¾†æœ‰æ©Ÿæœƒä¹Ÿæœƒç™¼ç›¸é—œæ–‡ç« èˆ‡å¤§å®¶è¨è«–ã€‚</p>
:ET